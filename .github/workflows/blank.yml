name: Kernel Update Sentinel
on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:

jobs:
  filter-kernel:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Analyze Remote Release
        run: |
          REPO="TheSillyOk/kernel_workflows"
          API_URL="https://api.github.com/repos/$REPO/releases"
          RELEASE_DATA=$(curl -s $API_URL | jq '.[0]')

          FILTER_LOGIC='.assets[] | select(.name | contains("Ginkgo") and contains("KSUNext") and contains("SUSFS"))'
          
          DOWNLOAD_URL=$(echo "$RELEASE_DATA" | jq -r "$FILTER_LOGIC | .browser_download_url" | head -n 1)
          FILE_NAME=$(echo "$RELEASE_DATA" | jq -r "$FILTER_LOGIC | .name" | head -n 1)
          TAG_NAME=$(echo "$RELEASE_DATA" | jq -r ".tag_name")
          # Mengambil tanggal rilis untuk standar FKM
          PUB_DATE=$(echo "$RELEASE_DATA" | jq -r ".published_at" | cut -d'T' -f1)

          if [ "$DOWNLOAD_URL" == "null" ] || [ -z "$DOWNLOAD_URL" ]; then
            echo "Kesalahan: Varian tidak ditemukan."
            exit 1
          fi

          # KOREKSI: Format JSON wajib mengikuti struktur 'kernel' agar valid di FKM
          echo "{
            \"kernel\": {
              \"name\": \"Ginkgo-KSUNext-SUSFS\",
              \"version\": \"$TAG_NAME\",
              \"link\": \"$DOWNLOAD_URL\",
              \"changelog_url\": \"https://github.com/$REPO/releases/tag/$TAG_NAME\",
              \"date\": \"$PUB_DATE\"
            }
          }" > update.json

      - name: Deploy Manifest
        run: |
          git config --local user.email "alice.synthesis@integrity.knight"
          git config --local user.name "Alice Synthesis Thirty"
          git add update.json
          git commit -m "Sentinel: Update manifest to FKM schema v1" || exit 0
          git push
